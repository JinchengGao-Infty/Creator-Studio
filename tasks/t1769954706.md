# 任务：T1.4 创建 ai-engine 包

## 任务目标

创建独立的 AI 引擎包，使用 Vercel AI SDK 实现多 Provider 支持和 Agent 循环。

## 参考代码

**OpenCode 的实现**（参考，不要照抄）：
- Provider 系统：`/Users/link/Desktop/opencode-Hydra/packages/opencode/src/provider/provider.ts`
- Tool 定义：`/Users/link/Desktop/opencode-Hydra/packages/opencode/src/tool/tool.ts`
- Agent 相关：`/Users/link/Desktop/opencode-Hydra/packages/opencode/src/agent/`

**Vercel AI SDK 文档**：https://sdk.vercel.ai/docs

## 你需要做的

### 1. 创建包结构

```bash
cd /Users/link/Desktop/creatorai-v2
mkdir -p packages/ai-engine/src
cd packages/ai-engine
```

创建 `package.json`：
```json
{
  "name": "@creatorai/ai-engine",
  "version": "0.1.0",
  "type": "module",
  "main": "src/index.ts",
  "scripts": {
    "build": "bun build src/index.ts --outdir dist --target node",
    "test": "bun test"
  },
  "dependencies": {
    "ai": "^4.0.0",
    "@ai-sdk/openai-compatible": "^0.1.0",
    "zod": "^3.23.0"
  },
  "devDependencies": {
    "@types/bun": "latest",
    "typescript": "^5.0.0"
  }
}
```

创建 `tsconfig.json`：
```json
{
  "compilerOptions": {
    "target": "ES2022",
    "module": "ESNext",
    "moduleResolution": "bundler",
    "strict": true,
    "esModuleInterop": true,
    "skipLibCheck": true,
    "outDir": "dist",
    "declaration": true
  },
  "include": ["src/**/*"]
}
```

### 2. 实现 src/types.ts

```typescript
// Provider 配置
export interface ProviderConfig {
  id: string
  name: string
  baseURL: string
  apiKey: string
  models: string[]
  providerType: 'openai-compatible' | 'google' | 'anthropic'
  headers?: Record<string, string>
}

// 模型参数
export interface ModelParameters {
  model: string
  temperature?: number
  topP?: number
  topK?: number
  maxTokens?: number
}

// Tool 定义
export interface ToolDefinition {
  name: string
  description: string
  parameters: Record<string, any>  // JSON Schema
}

// Tool 调用请求
export interface ToolCallRequest {
  id: string
  name: string
  args: Record<string, any>
}

// Tool 调用结果
export interface ToolCallResult {
  id: string
  result: string
  error?: string
}

// 消息
export interface Message {
  role: 'user' | 'assistant' | 'system' | 'tool'
  content: string
  toolCallId?: string
}

// Agent 运行结果
export interface AgentResult {
  content: string
  toolCalls?: ToolCallRequest[]
}
```

### 3. 实现 src/provider.ts

```typescript
import { createOpenAICompatible } from '@ai-sdk/openai-compatible'
import type { ProviderConfig } from './types'

export class ProviderManager {
  private providers: Map<string, ProviderConfig> = new Map()
  
  // 添加 Provider
  addProvider(config: ProviderConfig): void
  
  // 获取 Provider
  getProvider(id: string): ProviderConfig | undefined
  
  // 列出所有 Provider
  listProviders(): ProviderConfig[]
  
  // 创建 AI SDK 实例
  createSDK(providerId: string): ReturnType<typeof createOpenAICompatible>
}
```

### 4. 实现 src/tools.ts

```typescript
import { z } from 'zod'
import type { ToolDefinition } from './types'

// Tool 定义（只描述，不执行）
// 执行由 Tauri 后端完成

export const tools: ToolDefinition[] = [
  {
    name: 'read',
    description: '读取文件内容。用于读取章节、摘要、设定等文件。',
    parameters: {
      type: 'object',
      properties: {
        path: { type: 'string', description: '相对于项目目录的文件路径' },
        offset: { type: 'number', description: '起始行号（0-based）' },
        limit: { type: 'number', description: '读取行数（默认2000）' },
      },
      required: ['path'],
    },
  },
  {
    name: 'write',
    description: '写入文件内容（会自动备份旧内容）。',
    parameters: {
      type: 'object',
      properties: {
        path: { type: 'string', description: '相对于项目目录的文件路径' },
        content: { type: 'string', description: '文件内容' },
      },
      required: ['path', 'content'],
    },
  },
  {
    name: 'append',
    description: '追加内容到文件末尾（适合续写）。',
    parameters: {
      type: 'object',
      properties: {
        path: { type: 'string', description: '相对于项目目录的文件路径' },
        content: { type: 'string', description: '要追加的内容' },
      },
      required: ['path', 'content'],
    },
  },
  {
    name: 'list',
    description: '列出目录下的文件。',
    parameters: {
      type: 'object',
      properties: {
        path: { type: 'string', description: '相对于项目目录的目录路径' },
      },
      required: [],
    },
  },
  {
    name: 'search',
    description: '在项目内搜索关键词。',
    parameters: {
      type: 'object',
      properties: {
        query: { type: 'string', description: '搜索关键词' },
        path: { type: 'string', description: '搜索范围（目录路径）' },
      },
      required: ['query'],
    },
  },
]

// 转换为 Vercel AI SDK 格式
export function getToolsForSDK() {
  // 返回 AI SDK 需要的 tools 格式
}
```

### 5. 实现 src/agent.ts

```typescript
import { generateText } from 'ai'
import type { Message, ToolCallRequest, ToolCallResult, AgentResult, ModelParameters } from './types'
import { ProviderManager } from './provider'
import { getToolsForSDK } from './tools'

export interface AgentContext {
  providerId: string
  parameters: ModelParameters
  systemPrompt: string
  // Tool 执行回调（由外部提供，实际执行在 Tauri）
  executeTools: (calls: ToolCallRequest[]) => Promise<ToolCallResult[]>
  // 中断信号
  abortSignal?: AbortSignal
}

export class Agent {
  private providerManager: ProviderManager
  
  constructor(providerManager: ProviderManager) {
    this.providerManager = providerManager
  }
  
  // 运行 Agent
  async run(
    messages: Message[],
    context: AgentContext
  ): Promise<AgentResult> {
    const sdk = this.providerManager.createSDK(context.providerId)
    const model = sdk(context.parameters.model)
    
    const allMessages = [
      { role: 'system' as const, content: context.systemPrompt },
      ...messages,
    ]
    
    // 使用 Vercel AI SDK 的 generateText
    // 设置 maxSteps 让 SDK 自动处理多轮 tool calling
    const result = await generateText({
      model,
      messages: allMessages,
      tools: getToolsForSDK(),
      maxSteps: 10,
      abortSignal: context.abortSignal,
      // 自定义 tool 执行
      experimental_toolCallStreaming: false,
    })
    
    return {
      content: result.text,
      toolCalls: result.toolCalls,
    }
  }
}
```

### 6. 实现 src/index.ts

```typescript
export * from './types'
export * from './provider'
export * from './tools'
export * from './agent'

// 便捷函数
export function createEngine() {
  const providerManager = new ProviderManager()
  const agent = new Agent(providerManager)
  
  return {
    providerManager,
    agent,
  }
}
```

### 7. 安装依赖并测试

```bash
cd /Users/link/Desktop/creatorai-v2/packages/ai-engine
bun install
bun run build
```

### 8. 创建简单测试

创建 `src/test.ts`：
```typescript
import { createEngine } from './index'

const engine = createEngine()

// 添加测试 Provider
engine.providerManager.addProvider({
  id: 'test',
  name: 'Test Provider',
  baseURL: 'http://localhost:3000/v1',
  apiKey: 'test-key',
  models: ['test-model'],
  providerType: 'openai-compatible',
})

console.log('Providers:', engine.providerManager.listProviders())
console.log('ai-engine 包创建成功！')
```

运行：`bun src/test.ts`

## 输出

- `packages/ai-engine/` 包创建完成
- 能通过 `bun run build` 编译
- 能通过 `bun src/test.ts` 运行测试

## 完成标记

完成后在输出末尾标记：`[TASK_COMPLETE]`

如果遇到问题无法解决，标记：`[TASK_FAILED: 原因]`
