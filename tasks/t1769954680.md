# 任务：T1.2 实现 Rust 文件操作模块

## 任务目标

在 Tauri 后端实现安全的文件操作模块，供 AI Tool 调用。

## 参考代码

**OpenCode 的文件操作实现**（参考，不要照抄）：
- `/Users/link/Desktop/opencode-Hydra/packages/opencode/src/tool/read.ts`
- `/Users/link/Desktop/opencode-Hydra/packages/opencode/src/tool/write.ts`
- `/Users/link/Desktop/opencode-Hydra/packages/opencode/src/tool/tool.ts`

## 你需要做的

### 1. 创建模块结构

```
src-tauri/src/
├── main.rs
├── lib.rs
├── file_ops/
│   ├── mod.rs
│   ├── read.rs
│   ├── write.rs
│   ├── append.rs
│   ├── list.rs
│   └── search.rs
└── security.rs
```

### 2. 实现 security.rs - 路径安全校验

```rust
// 核心函数
pub fn validate_path(project_dir: &Path, relative_path: &str) -> Result<PathBuf, String>

// 要求：
// - 禁止 ".." 越界
// - 禁止绝对路径（如果传入绝对路径，返回错误）
// - 返回规范化的完整路径
// - 确保最终路径在 project_dir 下
```

### 3. 实现 file_ops/read.rs

```rust
// 参数
pub struct ReadParams {
    pub path: String,      // 相对路径
    pub offset: Option<u32>,  // 起始行号（0-based）
    pub limit: Option<u32>,   // 读取行数（默认 2000）
}

// 返回
pub struct ReadResult {
    pub content: String,   // 文件内容（带行号）
    pub total_lines: u32,  // 文件总行数
    pub truncated: bool,   // 是否被截断
}

// 要求：
// - 默认最多读取 2000 行
// - 单行最长 2000 字符，超出截断并加 "..."
// - 最大 50KB，超出截断
// - 输出格式：每行前加行号 "00001| 内容"
// - 检测二进制文件，拒绝读取
```

### 4. 实现 file_ops/write.rs

```rust
// 参数
pub struct WriteParams {
    pub path: String,      // 相对路径
    pub content: String,   // 文件内容
}

// 要求：
// - 写入前检查文件是否存在
// - 如果存在，先备份到 .backup/ 目录（带时间戳）
// - 创建父目录（如果不存在）
// - 返回写入结果
```

### 5. 实现 file_ops/append.rs

```rust
// 参数
pub struct AppendParams {
    pub path: String,      // 相对路径
    pub content: String,   // 要追加的内容
}

// 要求：
// - 如果文件不存在，创建新文件
// - 追加内容到文件末尾
// - 自动添加换行符（如果原文件末尾没有）
```

### 6. 实现 file_ops/list.rs

```rust
// 参数
pub struct ListParams {
    pub path: Option<String>,  // 相对路径（默认项目根目录）
}

// 返回
pub struct ListResult {
    pub entries: Vec<FileEntry>,
}

pub struct FileEntry {
    pub name: String,
    pub is_dir: bool,
    pub size: u64,
    pub modified: u64,  // Unix timestamp
}

// 要求：
// - 最多返回 100 个条目
// - 忽略隐藏文件（以 . 开头）
// - 忽略 node_modules、target、.git 等目录
```

### 7. 实现 file_ops/search.rs

```rust
// 参数
pub struct SearchParams {
    pub query: String,         // 搜索关键词
    pub path: Option<String>,  // 搜索范围（默认项目根目录）
}

// 返回
pub struct SearchResult {
    pub matches: Vec<SearchMatch>,
}

pub struct SearchMatch {
    pub file: String,
    pub line: u32,
    pub content: String,  // 匹配行的内容
}

// 要求：
// - 简单的字符串搜索（不需要正则）
// - 最多返回 50 个匹配
// - 忽略二进制文件
```

### 8. 注册 Tauri Commands

在 `lib.rs` 中注册命令：

```rust
#[tauri::command]
fn file_read(project_dir: String, params: ReadParams) -> Result<ReadResult, String>

#[tauri::command]
fn file_write(project_dir: String, params: WriteParams) -> Result<(), String>

#[tauri::command]
fn file_append(project_dir: String, params: AppendParams) -> Result<(), String>

#[tauri::command]
fn file_list(project_dir: String, params: ListParams) -> Result<ListResult, String>

#[tauri::command]
fn file_search(project_dir: String, params: SearchParams) -> Result<SearchResult, String>
```

## 测试

创建一个简单的测试：
1. 在项目根目录创建 `test.txt`
2. 调用 `file_read` 读取
3. 调用 `file_append` 追加内容
4. 调用 `file_list` 列出目录
5. 调用 `file_search` 搜索关键词

## 输出

- 所有文件操作模块实现完成
- Tauri commands 注册完成
- 能通过 `npm run tauri dev` 编译通过

## 完成标记

完成后在输出末尾标记：`[TASK_COMPLETE]`

如果遇到问题无法解决，标记：`[TASK_FAILED: 原因]`
