# 任务：T1.6 集成验证：AI 调用 Tool 读写文件

## 任务目标

验证整个链路能跑通：前端 → Tauri → ai-engine → 模型 → Tool 执行 → 返回结果

## 测试 API 配置

```
Base URL: http://127.0.0.1:3002/geminicli/v1
API Key: sk-XnbHbzBOmPYGHgL_4Mg8zRcoBIb2gVpJiuO0eSifyyCUV2Twz2c4SljcNCo
Model: gemini-3-flash
```

## 你需要做的

### 1. 创建测试页面

修改 `src/App.tsx`，添加一个简单的测试界面：

```tsx
import { useState } from 'react'
import { invoke } from '@tauri-apps/api/core'
import { Button, Input, Card, message, Spin } from 'antd'

const { TextArea } = Input

// 测试配置
const TEST_PROVIDER = {
  id: 'gemini',
  name: 'Gemini',
  baseURL: 'http://127.0.0.1:3002/geminicli/v1',
  apiKey: 'sk-XnbHbzBOmPYGHgL_4Mg8zRcoBIb2gVpJiuO0eSifyyCUV2Twz2c4SljcNCo',
  models: ['gemini-3-flash'],
  providerType: 'openai-compatible',
}

const TEST_PARAMETERS = {
  model: 'gemini-3-flash',
  temperature: 0.7,
  maxTokens: 2000,
}

const SYSTEM_PROMPT = `你是一个文件助手。你可以使用以下工具：
- read: 读取文件内容
- write: 写入文件内容
- append: 追加内容到文件
- list: 列出目录下的文件
- search: 搜索文件内容

当用户要求你操作文件时，请使用相应的工具。`

function App() {
  const [input, setInput] = useState('')
  const [output, setOutput] = useState('')
  const [loading, setLoading] = useState(false)
  const [projectDir, setProjectDir] = useState('/Users/link/Desktop/creatorai-v2')

  const handleSend = async () => {
    if (!input.trim()) return
    
    setLoading(true)
    setOutput('')
    
    try {
      const result = await invoke('ai_chat', {
        provider: TEST_PROVIDER,
        parameters: TEST_PARAMETERS,
        systemPrompt: SYSTEM_PROMPT,
        messages: [{ role: 'user', content: input }],
        projectDir: projectDir,
      })
      
      setOutput(result as string)
      message.success('AI 响应成功')
    } catch (error) {
      setOutput(`错误: ${error}`)
      message.error(`调用失败: ${error}`)
    } finally {
      setLoading(false)
    }
  }

  return (
    <div style={{ padding: 24, maxWidth: 800, margin: '0 auto' }}>
      <h1>CreatorAI - T1.6 集成测试</h1>
      
      <Card title="项目目录" style={{ marginBottom: 16 }}>
        <Input 
          value={projectDir} 
          onChange={e => setProjectDir(e.target.value)}
          placeholder="项目目录路径"
        />
      </Card>
      
      <Card title="测试用例" style={{ marginBottom: 16 }}>
        <p>试试这些命令：</p>
        <ul>
          <li><code>列出当前目录的文件</code></li>
          <li><code>读取 README.md 文件</code></li>
          <li><code>创建一个 test.txt 文件，内容是 "Hello CreatorAI"</code></li>
          <li><code>在 test.txt 末尾追加一行 "这是追加的内容"</code></li>
          <li><code>搜索包含 "tauri" 的文件</code></li>
        </ul>
      </Card>
      
      <Card title="输入" style={{ marginBottom: 16 }}>
        <TextArea
          rows={4}
          value={input}
          onChange={e => setInput(e.target.value)}
          placeholder="输入你的指令..."
          onPressEnter={e => {
            if (e.ctrlKey || e.metaKey) handleSend()
          }}
        />
        <Button 
          type="primary" 
          onClick={handleSend} 
          loading={loading}
          style={{ marginTop: 8 }}
        >
          发送 (Ctrl+Enter)
        </Button>
      </Card>
      
      <Card title="输出">
        {loading ? (
          <Spin tip="AI 正在思考..." />
        ) : (
          <pre style={{ whiteSpace: 'pre-wrap', wordBreak: 'break-word' }}>
            {output || '等待输入...'}
          </pre>
        )}
      </Card>
    </div>
  )
}

export default App
```

### 2. 确保依赖安装

```bash
cd /Users/link/Desktop/creatorai-v2
npm install @tauri-apps/api
```

### 3. 运行测试

```bash
npm run tauri dev
```

### 4. 执行测试用例

在界面中依次测试：

1. **测试 list**：输入 `列出当前目录的文件`
   - 预期：AI 调用 list tool，返回文件列表

2. **测试 read**：输入 `读取 README.md 文件`
   - 预期：AI 调用 read tool，返回文件内容

3. **测试 write**：输入 `创建一个 test.txt 文件，内容是 "Hello CreatorAI"`
   - 预期：AI 调用 write tool，创建文件

4. **测试 append**：输入 `在 test.txt 末尾追加一行 "这是追加的内容"`
   - 预期：AI 调用 append tool，追加内容

5. **测试 search**：输入 `搜索包含 "tauri" 的文件`
   - 预期：AI 调用 search tool，返回匹配结果

6. **测试路径安全**：输入 `读取 /etc/passwd 文件`
   - 预期：被拒绝，返回路径安全错误

### 5. 记录测试结果

创建 `docs/T1.6-test-report.md`，记录每个测试用例的结果：

```markdown
# T1.6 集成测试报告

## 测试环境
- 日期：2026-02-01
- API：http://127.0.0.1:3002/geminicli/v1
- Model：gemini-3-flash

## 测试结果

| 测试用例 | 输入 | 预期 | 实际 | 状态 |
|----------|------|------|------|------|
| list | 列出当前目录的文件 | 返回文件列表 | | |
| read | 读取 README.md | 返回文件内容 | | |
| write | 创建 test.txt | 文件被创建 | | |
| append | 追加到 test.txt | 内容被追加 | | |
| search | 搜索 "tauri" | 返回匹配结果 | | |
| 路径安全 | 读取 /etc/passwd | 被拒绝 | | |

## 问题与修复
（记录遇到的问题和解决方案）
```

## 输出

- 测试页面 `src/App.tsx` 更新
- 测试报告 `docs/T1.6-test-report.md`
- 所有测试用例通过

## 完成标记

完成后在输出末尾标记：`[TASK_COMPLETE]`

如果遇到问题无法解决，标记：`[TASK_FAILED: 原因]`
