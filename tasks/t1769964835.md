# 任务：T2.4 + T2.5 Provider 配置 UI + 模型参数 UI

## 任务目标

实现 Provider 配置界面和模型参数调节界面。

## 背景

后端已完成：
- `add_provider` / `update_provider` / `delete_provider` / `list_providers` / `set_active_provider`
- `get_api_key` - 获取 API Key
- `refresh_provider_models` / `get_provider_models` - 模型列表
- `get_default_parameters` / `set_default_parameters` - 模型参数

## 你需要做的

### 1. 创建设置页面组件

创建 `src/components/Settings/SettingsPanel.tsx`：

```tsx
import { useState, useEffect } from 'react'
import { Tabs } from 'antd'
import ProviderSettings from './ProviderSettings'
import ModelSettings from './ModelSettings'

export default function SettingsPanel() {
  return (
    <div style={{ padding: 16 }}>
      <Tabs
        items={[
          {
            key: 'provider',
            label: 'Provider 配置',
            children: <ProviderSettings />,
          },
          {
            key: 'model',
            label: '模型参数',
            children: <ModelSettings />,
          },
        ]}
      />
    </div>
  )
}
```

### 2. 实现 Provider 配置 UI

创建 `src/components/Settings/ProviderSettings.tsx`：

```tsx
import { useState, useEffect } from 'react'
import { invoke } from '@tauri-apps/api/core'
import { 
  Card, Button, Table, Modal, Form, Input, Select, 
  Space, message, Popconfirm, Tag 
} from 'antd'
import { PlusOutlined, EditOutlined, DeleteOutlined, ReloadOutlined } from '@ant-design/icons'

interface Provider {
  id: string
  name: string
  base_url: string
  models: string[]
  models_updated_at: number | null
  provider_type: string
}

export default function ProviderSettings() {
  const [providers, setProviders] = useState<Provider[]>([])
  const [activeProviderId, setActiveProviderId] = useState<string | null>(null)
  const [loading, setLoading] = useState(false)
  const [modalVisible, setModalVisible] = useState(false)
  const [editingProvider, setEditingProvider] = useState<Provider | null>(null)
  const [form] = Form.useForm()

  // 加载 Provider 列表
  const loadProviders = async () => {
    setLoading(true)
    try {
      const config = await invoke('get_config') as any
      setProviders(config.providers || [])
      setActiveProviderId(config.active_provider_id)
    } catch (error) {
      message.error(`加载失败: ${error}`)
    } finally {
      setLoading(false)
    }
  }

  useEffect(() => {
    loadProviders()
  }, [])

  // 添加/编辑 Provider
  const handleSubmit = async (values: any) => {
    try {
      if (editingProvider) {
        // 编辑
        await invoke('update_provider', {
          provider: {
            id: editingProvider.id,
            name: values.name,
            base_url: values.base_url,
            models: editingProvider.models,
            models_updated_at: editingProvider.models_updated_at,
            provider_type: values.provider_type,
          },
          apiKey: values.api_key || null,
        })
        message.success('更新成功')
      } else {
        // 添加
        const id = `provider_${Date.now()}`
        await invoke('add_provider', {
          provider: {
            id,
            name: values.name,
            base_url: values.base_url,
            models: [],
            models_updated_at: null,
            provider_type: values.provider_type,
          },
          apiKey: values.api_key,
        })
        message.success('添加成功')
      }
      setModalVisible(false)
      form.resetFields()
      setEditingProvider(null)
      loadProviders()
    } catch (error) {
      message.error(`操作失败: ${error}`)
    }
  }

  // 删除 Provider
  const handleDelete = async (id: string) => {
    try {
      await invoke('delete_provider', { providerId: id })
      message.success('删除成功')
      loadProviders()
    } catch (error) {
      message.error(`删除失败: ${error}`)
    }
  }

  // 设置为当前 Provider
  const handleSetActive = async (id: string) => {
    try {
      await invoke('set_active_provider', { providerId: id })
      message.success('已设置为当前 Provider')
      loadProviders()
    } catch (error) {
      message.error(`设置失败: ${error}`)
    }
  }

  // 刷新模型列表
  const handleRefreshModels = async (id: string) => {
    try {
      message.loading({ content: '正在获取模型列表...', key: 'refresh' })
      const models = await invoke('refresh_provider_models', { providerId: id })
      message.success({ content: `获取到 ${(models as string[]).length} 个模型`, key: 'refresh' })
      loadProviders()
    } catch (error) {
      message.error({ content: `获取失败: ${error}`, key: 'refresh' })
    }
  }

  // 打开编辑弹窗
  const openEditModal = async (provider: Provider) => {
    setEditingProvider(provider)
    // 获取 API Key
    try {
      const apiKey = await invoke('get_api_key', { providerId: provider.id })
      form.setFieldsValue({
        name: provider.name,
        base_url: provider.base_url,
        provider_type: provider.provider_type,
        api_key: apiKey || '',
      })
    } catch {
      form.setFieldsValue({
        name: provider.name,
        base_url: provider.base_url,
        provider_type: provider.provider_type,
        api_key: '',
      })
    }
    setModalVisible(true)
  }

  const columns = [
    {
      title: '名称',
      dataIndex: 'name',
      key: 'name',
      render: (name: string, record: Provider) => (
        <Space>
          {name}
          {record.id === activeProviderId && <Tag color="green">当前</Tag>}
        </Space>
      ),
    },
    {
      title: 'Base URL',
      dataIndex: 'base_url',
      key: 'base_url',
      ellipsis: true,
    },
    {
      title: '模型数',
      dataIndex: 'models',
      key: 'models',
      render: (models: string[]) => models?.length || 0,
    },
    {
      title: '操作',
      key: 'action',
      render: (_: any, record: Provider) => (
        <Space>
          {record.id !== activeProviderId && (
            <Button size="small" onClick={() => handleSetActive(record.id)}>
              设为当前
            </Button>
          )}
          <Button 
            size="small" 
            icon={<ReloadOutlined />} 
            onClick={() => handleRefreshModels(record.id)}
          >
            刷新模型
          </Button>
          <Button 
            size="small" 
            icon={<EditOutlined />} 
            onClick={() => openEditModal(record)}
          />
          <Popconfirm
            title="确定删除？"
            onConfirm={() => handleDelete(record.id)}
          >
            <Button size="small" danger icon={<DeleteOutlined />} />
          </Popconfirm>
        </Space>
      ),
    },
  ]

  return (
    <Card
      title="Provider 管理"
      extra={
        <Button 
          type="primary" 
          icon={<PlusOutlined />}
          onClick={() => {
            setEditingProvider(null)
            form.resetFields()
            setModalVisible(true)
          }}
        >
          添加 Provider
        </Button>
      }
    >
      <Table
        dataSource={providers}
        columns={columns}
        rowKey="id"
        loading={loading}
        pagination={false}
      />

      <Modal
        title={editingProvider ? '编辑 Provider' : '添加 Provider'}
        open={modalVisible}
        onCancel={() => {
          setModalVisible(false)
          setEditingProvider(null)
          form.resetFields()
        }}
        onOk={() => form.submit()}
      >
        <Form form={form} layout="vertical" onFinish={handleSubmit}>
          <Form.Item
            name="name"
            label="名称"
            rules={[{ required: true, message: '请输入名称' }]}
          >
            <Input placeholder="如：Deepseek、Gemini" />
          </Form.Item>
          <Form.Item
            name="base_url"
            label="Base URL"
            rules={[{ required: true, message: '请输入 Base URL' }]}
          >
            <Input placeholder="如：https://api.deepseek.com/v1" />
          </Form.Item>
          <Form.Item
            name="api_key"
            label="API Key"
            rules={[{ required: !editingProvider, message: '请输入 API Key' }]}
          >
            <Input.Password placeholder={editingProvider ? '留空则不修改' : '请输入 API Key'} />
          </Form.Item>
          <Form.Item
            name="provider_type"
            label="Provider 类型"
            initialValue="openai-compatible"
          >
            <Select>
              <Select.Option value="openai-compatible">OpenAI Compatible</Select.Option>
              <Select.Option value="google">Google</Select.Option>
              <Select.Option value="anthropic">Anthropic</Select.Option>
            </Select>
          </Form.Item>
        </Form>
      </Modal>
    </Card>
  )
}
```

### 3. 实现模型参数 UI

创建 `src/components/Settings/ModelSettings.tsx`：

```tsx
import { useState, useEffect } from 'react'
import { invoke } from '@tauri-apps/api/core'
import { Card, Form, Select, Slider, InputNumber, Button, message, Space } from 'antd'

interface ModelParameters {
  model: string
  temperature: number
  top_p: number
  top_k: number | null
  max_tokens: number
}

interface Provider {
  id: string
  name: string
  models: string[]
}

export default function ModelSettings() {
  const [form] = Form.useForm()
  const [providers, setProviders] = useState<Provider[]>([])
  const [activeProviderId, setActiveProviderId] = useState<string | null>(null)
  const [models, setModels] = useState<string[]>([])
  const [loading, setLoading] = useState(false)

  // 加载配置
  const loadConfig = async () => {
    setLoading(true)
    try {
      const config = await invoke('get_config') as any
      setProviders(config.providers || [])
      setActiveProviderId(config.active_provider_id)
      
      // 设置当前 Provider 的模型列表
      if (config.active_provider_id) {
        const provider = config.providers.find((p: Provider) => p.id === config.active_provider_id)
        if (provider) {
          setModels(provider.models || [])
        }
      }
      
      // 设置默认参数
      form.setFieldsValue({
        model: config.default_parameters.model,
        temperature: config.default_parameters.temperature,
        top_p: config.default_parameters.top_p,
        top_k: config.default_parameters.top_k,
        max_tokens: config.default_parameters.max_tokens,
      })
    } catch (error) {
      message.error(`加载失败: ${error}`)
    } finally {
      setLoading(false)
    }
  }

  useEffect(() => {
    loadConfig()
  }, [])

  // Provider 切换时更新模型列表
  const handleProviderChange = async (providerId: string) => {
    try {
      await invoke('set_active_provider', { providerId })
      const provider = providers.find(p => p.id === providerId)
      if (provider) {
        setModels(provider.models || [])
        setActiveProviderId(providerId)
        // 清空当前选择的模型
        form.setFieldValue('model', undefined)
      }
    } catch (error) {
      message.error(`切换失败: ${error}`)
    }
  }

  // 保存参数
  const handleSave = async (values: ModelParameters) => {
    try {
      await invoke('set_default_parameters', { parameters: values })
      message.success('保存成功')
    } catch (error) {
      message.error(`保存失败: ${error}`)
    }
  }

  return (
    <Card title="模型参数">
      <Form
        form={form}
        layout="vertical"
        onFinish={handleSave}
        style={{ maxWidth: 500 }}
      >
        <Form.Item label="当前 Provider">
          <Select
            value={activeProviderId}
            onChange={handleProviderChange}
            placeholder="选择 Provider"
          >
            {providers.map(p => (
              <Select.Option key={p.id} value={p.id}>{p.name}</Select.Option>
            ))}
          </Select>
        </Form.Item>

        <Form.Item
          name="model"
          label="模型"
          rules={[{ required: true, message: '请选择模型' }]}
        >
          <Select placeholder="选择模型" showSearch>
            {models.map(m => (
              <Select.Option key={m} value={m}>{m}</Select.Option>
            ))}
          </Select>
        </Form.Item>

        <Form.Item
          name="temperature"
          label="Temperature"
          tooltip="控制输出的随机性，值越高越随机"
        >
          <Slider
            min={0}
            max={2}
            step={0.1}
            marks={{ 0: '0', 1: '1', 2: '2' }}
          />
        </Form.Item>

        <Form.Item
          name="top_p"
          label="Top P"
          tooltip="核采样参数，控制输出的多样性"
        >
          <Slider
            min={0}
            max={1}
            step={0.05}
            marks={{ 0: '0', 0.5: '0.5', 1: '1' }}
          />
        </Form.Item>

        <Form.Item
          name="top_k"
          label="Top K"
          tooltip="限制每次采样的候选词数量（可选）"
        >
          <InputNumber min={1} max={100} placeholder="留空则不限制" style={{ width: '100%' }} />
        </Form.Item>

        <Form.Item
          name="max_tokens"
          label="Max Tokens"
          tooltip="最大输出长度"
          rules={[{ required: true, message: '请输入最大 Token 数' }]}
        >
          <InputNumber min={100} max={32000} style={{ width: '100%' }} />
        </Form.Item>

        <Form.Item>
          <Button type="primary" htmlType="submit" loading={loading}>
            保存设置
          </Button>
        </Form.Item>
      </Form>
    </Card>
  )
}
```

### 4. 创建 index 导出

创建 `src/components/Settings/index.ts`：

```typescript
export { default as SettingsPanel } from './SettingsPanel'
export { default as ProviderSettings } from './ProviderSettings'
export { default as ModelSettings } from './ModelSettings'
```

### 5. 更新 App.tsx 添加设置入口

更新 `src/App.tsx`，添加设置页面的入口（可以用 Tab 或按钮切换）：

```tsx
import { useState } from 'react'
import { Tabs } from 'antd'
import { SettingsPanel } from './components/Settings'

function App() {
  const [activeTab, setActiveTab] = useState('test')

  return (
    <div style={{ padding: 24 }}>
      <Tabs
        activeKey={activeTab}
        onChange={setActiveTab}
        items={[
          {
            key: 'test',
            label: '测试',
            children: <TestPanel />,  // 之前的测试页面
          },
          {
            key: 'settings',
            label: '设置',
            children: <SettingsPanel />,
          },
        ]}
      />
    </div>
  )
}
```

### 6. 确保依赖安装

```bash
npm install @tauri-apps/api
```

### 7. 测试

1. 运行 `npm run tauri dev`
2. 进入设置页面
3. 添加一个 Provider（使用测试 API）：
   - 名称：Gemini
   - Base URL：http://127.0.0.1:3002/geminicli/v1
   - API Key：sk-XnbHbzBOmPYGHgL_4Mg8zRcoBIb2gVpJiuO0eSifyyCUV2Twz2c4SljcNCo
4. 点击"刷新模型"获取模型列表
5. 设置为当前 Provider
6. 切换到模型参数页面
7. 选择模型，调整参数，保存

## 输出

- `src/components/Settings/SettingsPanel.tsx`
- `src/components/Settings/ProviderSettings.tsx`
- `src/components/Settings/ModelSettings.tsx`
- `src/components/Settings/index.ts`
- `src/App.tsx` 更新
- `npm run build` 通过

## 完成标记

完成后在输出末尾标记：`[TASK_COMPLETE]`

如果遇到问题无法解决，标记：`[TASK_FAILED: 原因]`
