# 任务：T2.1 + T2.2 Provider 数据结构与 API Key 安全存储

## 任务目标

1. **T2.1**：实现 Provider 配置的数据结构与持久化存储
2. **T2.2**：实现 API Key 的安全存储（使用 OS Keychain）

## 你需要做的

### 1. 定义数据结构

创建 `src-tauri/src/config.rs`：

```rust
use serde::{Deserialize, Serialize};
use std::collections::HashMap;

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct GlobalConfig {
    pub schema_version: u32,
    pub providers: Vec<Provider>,
    pub active_provider_id: Option<String>,
    pub default_parameters: ModelParameters,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct Provider {
    pub id: String,
    pub name: String,
    pub base_url: String,
    // API Key 不存在这里，存在 Keychain
    pub models: Vec<String>,
    pub models_updated_at: Option<u64>,
    pub provider_type: ProviderType,
    pub headers: Option<HashMap<String, String>>,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
#[serde(rename_all = "kebab-case")]
pub enum ProviderType {
    OpenaiCompatible,
    Google,
    Anthropic,
}

#[derive(Debug, Clone, Serialize, Deserialize)]
pub struct ModelParameters {
    pub model: String,
    pub temperature: f32,
    pub top_p: f32,
    pub top_k: Option<u32>,
    pub max_tokens: u32,
}

impl Default for GlobalConfig {
    fn default() -> Self {
        Self {
            schema_version: 1,
            providers: vec![],
            active_provider_id: None,
            default_parameters: ModelParameters::default(),
        }
    }
}

impl Default for ModelParameters {
    fn default() -> Self {
        Self {
            model: String::new(),
            temperature: 0.7,
            top_p: 1.0,
            top_k: None,
            max_tokens: 2000,
        }
    }
}
```

### 2. 实现配置文件读写

在 `src-tauri/src/config.rs` 添加：

```rust
use std::path::PathBuf;
use std::fs;

fn get_config_dir() -> Result<PathBuf, String> {
    let home = dirs::home_dir().ok_or("Cannot find home directory")?;
    let config_dir = home.join(".creatorai");
    if !config_dir.exists() {
        fs::create_dir_all(&config_dir).map_err(|e| e.to_string())?;
    }
    Ok(config_dir)
}

fn get_config_path() -> Result<PathBuf, String> {
    Ok(get_config_dir()?.join("config.json"))
}

pub fn load_config() -> Result<GlobalConfig, String> {
    let path = get_config_path()?;
    if !path.exists() {
        return Ok(GlobalConfig::default());
    }
    let content = fs::read_to_string(&path).map_err(|e| e.to_string())?;
    serde_json::from_str(&content).map_err(|e| e.to_string())
}

pub fn save_config(config: &GlobalConfig) -> Result<(), String> {
    let path = get_config_path()?;
    let content = serde_json::to_string_pretty(config).map_err(|e| e.to_string())?;
    fs::write(&path, content).map_err(|e| e.to_string())
}
```

### 3. 实现 API Key 安全存储

添加 `keyring` 依赖到 `src-tauri/Cargo.toml`：

```toml
[dependencies]
keyring = "2"
```

创建 `src-tauri/src/keyring_store.rs`：

```rust
use keyring::Entry;

const SERVICE_NAME: &str = "creatorai";

pub fn store_api_key(provider_id: &str, api_key: &str) -> Result<(), String> {
    let entry = Entry::new(SERVICE_NAME, provider_id).map_err(|e| e.to_string())?;
    entry.set_password(api_key).map_err(|e| e.to_string())
}

pub fn get_api_key(provider_id: &str) -> Result<Option<String>, String> {
    let entry = Entry::new(SERVICE_NAME, provider_id).map_err(|e| e.to_string())?;
    match entry.get_password() {
        Ok(key) => Ok(Some(key)),
        Err(keyring::Error::NoEntry) => Ok(None),
        Err(e) => Err(e.to_string()),
    }
}

pub fn delete_api_key(provider_id: &str) -> Result<(), String> {
    let entry = Entry::new(SERVICE_NAME, provider_id).map_err(|e| e.to_string())?;
    match entry.delete_credential() {
        Ok(_) => Ok(()),
        Err(keyring::Error::NoEntry) => Ok(()), // 不存在也算成功
        Err(e) => Err(e.to_string()),
    }
}
```

### 4. 注册 Tauri Commands

在 `src-tauri/src/lib.rs` 添加：

```rust
mod config;
mod keyring_store;

use config::{GlobalConfig, Provider, ModelParameters};

// ===== Config Commands =====

#[tauri::command]
fn get_config() -> Result<GlobalConfig, String> {
    config::load_config()
}

#[tauri::command]
fn save_config(config: GlobalConfig) -> Result<(), String> {
    config::save_config(&config)
}

// ===== Provider Commands =====

#[tauri::command]
fn list_providers() -> Result<Vec<Provider>, String> {
    let config = config::load_config()?;
    Ok(config.providers)
}

#[tauri::command]
fn add_provider(provider: Provider, api_key: String) -> Result<(), String> {
    // 保存 API Key 到 Keychain
    keyring_store::store_api_key(&provider.id, &api_key)?;
    
    // 保存 Provider 到配置
    let mut config = config::load_config()?;
    
    // 检查是否已存在
    if config.providers.iter().any(|p| p.id == provider.id) {
        return Err(format!("Provider {} already exists", provider.id));
    }
    
    config.providers.push(provider);
    config::save_config(&config)
}

#[tauri::command]
fn update_provider(provider: Provider, api_key: Option<String>) -> Result<(), String> {
    // 如果提供了新的 API Key，更新 Keychain
    if let Some(key) = api_key {
        keyring_store::store_api_key(&provider.id, &key)?;
    }
    
    // 更新配置
    let mut config = config::load_config()?;
    if let Some(p) = config.providers.iter_mut().find(|p| p.id == provider.id) {
        *p = provider;
    } else {
        return Err(format!("Provider {} not found", provider.id));
    }
    config::save_config(&config)
}

#[tauri::command]
fn delete_provider(provider_id: String) -> Result<(), String> {
    // 删除 Keychain 中的 API Key
    keyring_store::delete_api_key(&provider_id)?;
    
    // 从配置中删除
    let mut config = config::load_config()?;
    config.providers.retain(|p| p.id != provider_id);
    
    // 如果删除的是当前激活的 Provider，清空激活状态
    if config.active_provider_id.as_ref() == Some(&provider_id) {
        config.active_provider_id = None;
    }
    
    config::save_config(&config)
}

#[tauri::command]
fn set_active_provider(provider_id: String) -> Result<(), String> {
    let mut config = config::load_config()?;
    
    // 检查 Provider 是否存在
    if !config.providers.iter().any(|p| p.id == provider_id) {
        return Err(format!("Provider {} not found", provider_id));
    }
    
    config.active_provider_id = Some(provider_id);
    config::save_config(&config)
}

#[tauri::command]
fn get_api_key(provider_id: String) -> Result<Option<String>, String> {
    keyring_store::get_api_key(&provider_id)
}

// ===== Parameters Commands =====

#[tauri::command]
fn get_default_parameters() -> Result<ModelParameters, String> {
    let config = config::load_config()?;
    Ok(config.default_parameters)
}

#[tauri::command]
fn set_default_parameters(parameters: ModelParameters) -> Result<(), String> {
    let mut config = config::load_config()?;
    config.default_parameters = parameters;
    config::save_config(&config)
}

// 在 run() 函数中注册所有命令
.invoke_handler(tauri::generate_handler![
    // ... 现有命令
    get_config,
    save_config,
    list_providers,
    add_provider,
    update_provider,
    delete_provider,
    set_active_provider,
    get_api_key,
    get_default_parameters,
    set_default_parameters,
])
```

### 5. 添加 dirs 依赖

在 `src-tauri/Cargo.toml` 添加：

```toml
[dependencies]
dirs = "5"
```

### 6. 测试

创建测试验证：

```rust
#[cfg(test)]
mod tests {
    use super::*;
    
    #[test]
    fn test_config_save_load() {
        let mut config = GlobalConfig::default();
        config.providers.push(Provider {
            id: "test".to_string(),
            name: "Test Provider".to_string(),
            base_url: "http://localhost:3000".to_string(),
            models: vec!["model-1".to_string()],
            models_updated_at: None,
            provider_type: ProviderType::OpenaiCompatible,
            headers: None,
        });
        
        save_config(&config).unwrap();
        let loaded = load_config().unwrap();
        
        assert_eq!(loaded.providers.len(), 1);
        assert_eq!(loaded.providers[0].id, "test");
    }
}
```

## 输出

- `src-tauri/src/config.rs` - 配置数据结构与读写
- `src-tauri/src/keyring_store.rs` - API Key 安全存储
- Tauri commands 注册完成
- `cargo test` 通过
- `cargo check` 通过

## 完成标记

完成后在输出末尾标记：`[TASK_COMPLETE]`

如果遇到问题无法解决，标记：`[TASK_FAILED: 原因]`
