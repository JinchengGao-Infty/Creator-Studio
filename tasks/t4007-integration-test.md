# T4.7 集成验证：完整的 AI 对话和续写

## 目标
验证 Phase 4 所有功能的完整性和协同工作。

## 输入
- T4.1 ~ T4.6 完成的所有功能

## 输出
- 验证报告
- 发现的问题修复

## 验证清单

### 1. 会话管理
- [ ] 创建讨论模式会话
- [ ] 创建续写模式会话
- [ ] 切换会话，历史正确加载
- [ ] 重命名会话
- [ ] 删除会话（确认弹窗）
- [ ] 会话列表搜索过滤

### 2. 讨论模式
- [ ] 发送消息，收到 AI 回复
- [ ] 流式输出正常显示
- [ ] 对话上下文连贯（追问能理解前文）
- [ ] 消息历史正确保存
- [ ] 关闭重开后历史保留

### 3. 续写模式
- [ ] 基于当前章节内容续写
- [ ] AI 返回正确的 JSON 格式
- [ ] 预览显示正文和摘要
- [ ] "追加到章节"功能正常
- [ ] 章节内容正确更新
- [ ] 摘要正确保存
- [ ] 编辑器实时刷新

### 4. 写作预设
- [ ] 创建新预设
- [ ] 编辑预设（文风、视角、时态、规则）
- [ ] 切换预设
- [ ] 预设影响 AI 输出风格
- [ ] 预设正确持久化

### 5. 跨功能测试
- [ ] 切换章节后，续写模式使用新章节内容
- [ ] 切换预设后，讨论和续写都使用新预设
- [ ] 多个会话之间互不干扰
- [ ] 错误处理（网络错误、API 错误）

## 测试场景

### 场景 1：完整的讨论流程
```
1. 新建项目，创建第一章
2. 打开 AI 面板，创建讨论会话"角色设定"
3. 发送："帮我设计一个主角，是个年轻的剑客"
4. 等待 AI 回复
5. 追问："他的武功特点是什么"
6. 验证上下文连贯
7. 切换到其他会话再切回，验证历史保留
```

### 场景 2：完整的续写流程
```
1. 在第一章写入一段开头内容
2. 切换到续写模式，创建续写会话
3. 发送："继续写，主角遇到一个神秘老人"
4. 等待 AI 返回 JSON
5. 预览续写内容和摘要
6. 点击"追加到章节"
7. 验证章节内容更新
8. 验证摘要保存
```

### 场景 3：预设影响测试
```
1. 创建新预设"武侠风格"
   - 文风：古典雅致
   - 视角：第三人称全知
   - 规则：多用四字成语、注重江湖气息
2. 切换到该预设
3. 进行续写
4. 验证输出风格符合预设
```

### 场景 4：错误处理测试
```
1. 断开网络，发送消息
2. 验证错误提示友好
3. 恢复网络，重试成功
4. 配置错误的 API Key
5. 验证错误提示明确
```

## 验证报告模板

```markdown
# Phase 4 集成验证报告

## 测试环境
- 日期：YYYY-MM-DD
- 系统：macOS / Windows
- 项目版本：xxx

## 测试结果

### 会话管理
| 功能 | 状态 | 备注 |
|------|------|------|
| 创建会话 | ✅/❌ | |
| 切换会话 | ✅/❌ | |
| 重命名会话 | ✅/❌ | |
| 删除会话 | ✅/❌ | |

### 讨论模式
| 功能 | 状态 | 备注 |
|------|------|------|
| 发送消息 | ✅/❌ | |
| 流式输出 | ✅/❌ | |
| 上下文连贯 | ✅/❌ | |
| 历史保存 | ✅/❌ | |

### 续写模式
| 功能 | 状态 | 备注 |
|------|------|------|
| JSON 解析 | ✅/❌ | |
| 预览显示 | ✅/❌ | |
| 追加到章节 | ✅/❌ | |
| 摘要保存 | ✅/❌ | |

### 写作预设
| 功能 | 状态 | 备注 |
|------|------|------|
| 创建预设 | ✅/❌ | |
| 编辑预设 | ✅/❌ | |
| 预设生效 | ✅/❌ | |

## 发现的问题
1. [问题描述] - [严重程度] - [修复状态]

## 结论
- [ ] Phase 4 验证通过，可进入 Phase 5
- [ ] 存在阻塞问题，需要修复后重新验证
```

## 验收标准
1. [ ] 所有测试场景通过
2. [ ] 无阻塞性 bug
3. [ ] 验证报告完成
4. [ ] `npm run build` 和 `cargo test` 通过

## 修复范围
如果发现问题，在本任务中修复以下范围的 bug：
- UI 显示问题
- 数据保存问题
- 流程逻辑问题

以下问题记录但不在本任务修复：
- 性能优化
- 样式美化
- 新功能需求
