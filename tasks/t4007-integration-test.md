# T4.7 集成验证：完整的 AI Agent 功能

## 目标
验证 Phase 4 所有功能的完整性，**重点验证 AI Agent 的 Tool 调用能力**。

## 核心验证点

这不是普通的"对话测试"，而是验证 **AI Agent 能否自主完成任务**：
- AI 能否自己决定调用哪些 Tools
- Tool 调用链是否正确执行
- 文件操作是否真正生效
- 整个工作流是否流畅

## 输入
- T4.1 ~ T4.6 完成的所有功能

## 输出
- 验证报告
- 发现的问题修复

## 验证场景

### 场景 1：讨论模式 - AI 自主读取章节
```
准备：创建项目，写入第一章内容（约1000字）

用户：帮我看看第一章的开头写得怎么样

期望 AI 行为：
1. 自动调用 read 读取 chapters/chapter_001.txt
2. 基于读取内容给出具体评价
3. 引用原文中的句子

验证点：
- [ ] AI 主动调用了 read Tool
- [ ] Tool 调用 UI 正确显示
- [ ] AI 回复引用了实际内容
```

### 场景 2：讨论模式 - AI 搜索摘要
```
准备：项目中有多个章节和摘要

用户：之前有没有写过打斗场面？

期望 AI 行为：
1. 自动调用 search 搜索 summaries.json
2. 列出找到的相关摘要
3. 给出分析

验证点：
- [ ] AI 主动调用了 search Tool
- [ ] 搜索结果正确返回
- [ ] AI 基于搜索结果回答
```

### 场景 3：讨论模式 - AI 列出目录
```
用户：我现在写了哪些章节？

期望 AI 行为：
1. 自动调用 list 列出 chapters 目录
2. 整理成清晰的列表展示

验证点：
- [ ] AI 主动调用了 list Tool
- [ ] 目录内容正确返回
```

### 场景 4：续写模式 - 完整工作流
```
准备：第三章已有 2000 字内容

用户：继续写，主角发现一个秘密

期望 AI 行为：
1. 自动调用 read 读取第三章末尾
2. 可能调用 search 搜索相关摘要
3. 生成续写内容并展示预览
4. 用户确认后调用 append 追加
5. 调用 save_summary 保存摘要

验证点：
- [ ] AI 自动读取了上下文
- [ ] 续写内容与前文风格一致
- [ ] 预览 UI 正确显示
- [ ] append 成功执行
- [ ] 章节文件实际更新
- [ ] 摘要正确保存
- [ ] 编辑器刷新显示新内容
```

### 场景 5：续写模式 - 重新生成
```
用户：继续写一段对话

AI 生成预览...

用户：不太好，重新生成

期望：
- [ ] AI 重新生成不同内容
- [ ] 之前的预览被替换
```

### 场景 6：错误处理
```
测试 1：读取不存在的文件
用户：帮我看看第十章（实际不存在）

期望：
- [ ] Tool 调用显示错误状态
- [ ] AI 友好地告知文件不存在

测试 2：网络错误
断开网络后发送消息

期望：
- [ ] 错误提示友好
- [ ] 可以重试
```

### 场景 7：写作预设生效
```
准备：创建"武侠风格"预设
- 文风：古典雅致
- 规则：多用四字成语

用户：（续写模式）继续写一段打斗

验证点：
- [ ] 续写内容符合预设风格
- [ ] 有四字成语出现
```

### 场景 8：多会话隔离
```
1. 创建会话 A（讨论模式），聊角色设定
2. 创建会话 B（续写模式），续写第一章
3. 切换回会话 A

验证点：
- [ ] 会话 A 的历史完整保留
- [ ] 会话 B 的 Tool 调用不影响会话 A
- [ ] 切换流畅
```

## 验证清单

### Tool 调用能力
| 功能 | 状态 | 备注 |
|------|------|------|
| AI 自主调用 read | ⬜ | |
| AI 自主调用 list | ⬜ | |
| AI 自主调用 search | ⬜ | |
| AI 自主调用 append | ⬜ | |
| AI 自主调用 save_summary | ⬜ | |
| Tool 调用 UI 显示 | ⬜ | |
| Tool 错误处理 | ⬜ | |

### 讨论模式
| 功能 | 状态 | 备注 |
|------|------|------|
| 基于文件内容回答 | ⬜ | |
| 搜索摘要 | ⬜ | |
| 上下文连贯 | ⬜ | |
| 不会误写文件 | ⬜ | |

### 续写模式
| 功能 | 状态 | 备注 |
|------|------|------|
| 自动读取上下文 | ⬜ | |
| 预览显示 | ⬜ | |
| 确认后追加 | ⬜ | |
| 摘要保存 | ⬜ | |
| 编辑器刷新 | ⬜ | |
| 重新生成 | ⬜ | |

### 写作预设
| 功能 | 状态 | 备注 |
|------|------|------|
| 预设影响输出风格 | ⬜ | |
| 规则被遵守 | ⬜ | |

### 会话管理
| 功能 | 状态 | 备注 |
|------|------|------|
| 多会话隔离 | ⬜ | |
| 历史保存 | ⬜ | |

## 验收标准
1. [ ] 所有 Tool 调用场景通过
2. [ ] 讨论模式能正确读取和分析
3. [ ] 续写模式完整工作流通过
4. [ ] 文件实际被修改（不是假的）
5. [ ] 无阻塞性 bug
6. [ ] `npm run build` 和 `cargo test` 通过

## 关键验证：文件真的被改了吗？

```bash
# 续写后检查文件
cat ~/test-project/chapters/chapter_003.txt | tail -20

# 检查摘要
cat ~/test-project/summaries.json | jq '.[-1]'
```

这是最重要的验证点：**AI 不是在演戏，而是真的在操作文件**。
